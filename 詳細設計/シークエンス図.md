#### 商品一覧表示
<div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant Product

    User->>Frontend: 商品一覧画面を開く
    Frontend->>ProductController: GET /products
    ProductController->>ProductService: findAllProducts()
    ProductService->>ProductRepository: findAll()
    ProductRepository->>Product: 商品一覧 + 画像取得
    Product-->>ProductRepository: 商品データリスト
    ProductRepository-->>ProductService: List<Product>
    ProductService-->>ProductController: List<Product>
    ProductController-->>Frontend: ResponseEntity<List<Product>>
    Frontend-->>User: 商品一覧を表示


</div>

#### 商品詳細表示
<div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant ProductController
    participant ProductService
    participant ProductRepository
    participant Product

    User->>Frontend: 商品をクリック（商品ID = P001）
    Frontend->>ProductController: GET /products/P001
    ProductController->>ProductService: findProductById("P001")
    ProductService->>ProductRepository: findById("P001")
    ProductRepository->>Product: 商品 + 画像取得
    Product-->>ProductRepository:商品データ(P001)
    ProductRepository-->>ProductService: Product
    ProductService-->>ProductController: Product
    ProductController-->>Frontend: ResponseEntity<Product>
    Frontend-->>User: 商品詳細を表示

</div>

#### カート追加
<div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant CartController
    participant CartService
    participant CartRepository
    participant CartItemRepository
    participant ProductRepository
    participant Product
    participant Cart
    participant CartItem

    User->>Frontend: 商品を「カートに追加」
    Frontend->>CartController: POST /cart/add (productId, quantity)
    CartController->>CartService: addItem(cartId, productId, quantity)

    CartService->>ProductRepository: findById(productId)
    ProductRepository-->>CartService: Product

    CartService->>CartRepository: findBySessionId(sessionId)
    alt カートが存在しない
        CartService->>CartRepository: save(new Cart)
    end
    CartRepository-->>CartService: Cart

    CartService->>CartItemRepository: findByCartId(cartId)
    alt 商品がすでにカートにある
        CartService->>Cart: updateItem(existingItem, quantity)
        CartService->>CartItemRepository: save(updatedItem)
    else 新しい商品を追加
        CartService->>CartItem: new CartItem(productId, quantity)
        CartService->>Cart: addItem(newItem)
        CartService->>CartItemRepository: save(newItem)
    end

    CartService->>CartRepository: save(updatedCart)
    CartService-->>CartController: Cart
    CartController-->>Frontend: ResponseEntity<CartDTO>
    Frontend-->>User: カート更新済み表示
</div>

#### カート表示・編集
##### カート情報取得
##### カート数量変更
##### カート商品削除


#### 注文確定
##### 会員
<div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant OrderController
    participant OrderService
    participant CartService
    participant CartRepository
    participant ProductRepository
    participant OrderRepository
    participant Product

    User->>Frontend: 「注文を確定する」クリック
    Frontend->>OrderController: POST /orders/confirm (userId)
    OrderController->>OrderService: placeOrder(userId)

    OrderService->>CartService: getCart(userId)
    CartService->>CartRepository: findByUserId(userId)
    CartRepository-->>CartService: Cart

    loop カート内商品ごとに
        OrderService->>ProductRepository: findById(productId)
        ProductRepository-->>OrderService: Product
        OrderService->>Product: reduceStock(quantity)
        OrderService->>ProductRepository: save(Product)
    end

    OrderService->>OrderRepository: save(new Order)
    OrderService->>CartService: clearCart(userId)

    OrderService-->>OrderController: Order
    OrderController-->>Frontend: ResponseEntity<OrderDTO>
    Frontend-->>User: 「注文完了」画面表示
</div>

##### 非会員
<div class="mermaid">
sequenceDiagram
    participant GuestUser
    participant Frontend
    participant OrderController
    participant OrderService
    participant CartService
    participant CartRepository
    participant ProductRepository
    participant OrderRepository
    participant Product

    GuestUser->>Frontend: 「注文を確定する」クリック
    Frontend->>OrderController: POST /orders/guest/confirm (sessionId, address, name, etc)
    OrderController->>OrderService: placeGuestOrder(sessionId, guestInfo)

    OrderService->>CartService: getCart(sessionId)
    CartService->>CartRepository: findBySessionId(sessionId)
    CartRepository-->>CartService: Cart

    loop カート内商品ごとに
        OrderService->>ProductRepository: findById(productId)
        ProductRepository-->>OrderService: Product
        OrderService->>Product: reduceStock(quantity)
        OrderService->>ProductRepository: save(Product)
    end

    OrderService->>OrderRepository: save(new GuestOrder)
    OrderService->>CartService: clearCart(sessionId)

    OrderService-->>OrderController: GuestOrder
    OrderController-->>Frontend: ResponseEntity<OrderDTO>
    Frontend-->>GuestUser: 「注文完了」画面表示

</div>
